#!/usr/bin/env perl
use v5.10;
use File::Spec;
use Getopt::Long;
use Data::Dump qw{ dump };

my $VERSION = $ENV{TOMCAT_VERSION};
my $HOME    = $ENV{HOME} // "$ENV{HOMEDRIVE}$ENV{HOMEPATH}";

GetOptions(
    'version=s'     => \$VERSION,
    'list'          => sub { exit list($VERSION) }, # list versions
    'help'          => \&help,
    'shutdown|down' => sub { exit ctl(shutdown => $VERSION) },
    'startup|up'    => sub { exit ctl(startup  => $VERSION) },
    'restart|re'    => sub {      ctl(shutdown => $VERSION);
                             exit ctl(startup  => $VERSION) },
    'ping'          => sub { },
    'install'       => sub { }
);

error(\&help) unless @ARGV;

#
# Functions

sub path { File::Spec->join(@_) }

sub error {
    my ($code, @msg) = @_;

    say STDERR @msg if @msg;
    
    if ( $code && ref $code eq 'CODE' ) {
        $code->(@msg);
    }

    exit 1;
}

#
# Commands
sub ctl {
    my ($cmd, $version) = @_;

    my $ext = $^O =~ /win32/i ? '.bat' : '.sh';
    my $root = path($HOME => local => "apache-tomcat-$version");
    my $bin  = path($root => bin => "${cmd}${ext}");

    $ENV{CATALINA_HOME} = $root; # for windows scripts

    error(\&help => "must specify version") unless $version;

    if ( -e $bin ) {
        say "$cmd: Tomcat $version...";
        say "running '$bin'";
        system $bin;
        say "DONE.";
        return 0;
    }
    else {
        say STDERR "'$bin' doesn't exist";
        return 1;
    }
}

sub deploy {
    my ($war) = @_;
    say $war;
    return 0;
}

sub list {
    my ($version) = @_;
    say "Installed Tomcat Versions:";
    say for map { $version && /$version/ ? "$_ * default " : $_ }
        map { /(\d\.\d(?:\.\d\d)?)/g; $1 }
        glob "$HOME/local/apache-tomcat-*";

    return 0;
}

sub help {
    say <<HELP;
Usage: $0 [OPTIONS]

  Options:
     --version, -v VERSION
        Specify a version to start
     
     --list, -l
        List installed versions

     --help, -h

     --startup, -up
        Startup tomcat server

     --shutdown, -down
        Shutdown tomcat server

     --restart, -re
        Restart tomcat server

  returns 0 on success and 1 on failure
HELP

    exit 0;
}
